"use strict";function Query(e){return this.config=e,this}module.exports=require("./").polyfill();var realFetch=require("node-fetch");module.exports=function(e,t){return/^\/\//.test(e)&&(e="https:"+e),realFetch.call(this,e,t)},global.fetch||(global.fetch=module.exports,global.Response=realFetch.Response,global.Headers=realFetch.Headers,global.Request=realFetch.Request),Query.prototype.fromRequest=function(e){this.method=e.method,this.metaId=e.url.split("?")[0],this.args=e.query,this.data=e.body,this.args.metaData=!this.args.hasOwnProperty("metaData")||this.args.metaData,console.log("fromRequest args",this.args)},Query.prototype.fromDatum=function(e,t,r,s){var o=this;this.method=e,this.metaId=t.toUrl(),this.args=r||{},this.data=s||{},this.args.metaData=!this.args.hasOwnProperty("metaData")||this.args.metaData,this.queryString=Object.keys(this.args).sort().map(function(e){var t=o.args[e];switch(e){case"where":return(t=t.length?t:[t]).map(function(e){return"where="+encodeURIComponent(JSON.stringify(e))}).join("&");case"order_by":return t=t.length?t:[t],e+"="+encodeURIComponent(t.map(function(e,t){return("asc"!==e.direction?"-":"")+e.column}).join(","));case"limit":case"offset":var r=parseInt(t);if(!isNaN(r))return e+"="+r;return;case"evented":return"session_id="+encodeURIComponent(JSON.stringify(t));case"metaData":case"args":case"exclude":case"include":return e+"="+encodeURIComponent(JSON.stringify(t))}}).join("&").replace(/&&/g,"&"),console.log("fromDatum queryString",this.queryString)},Query.prototype.fetch=function(){var e=this,t=("/"+this.config.url+"/"+this.config.version).replace(/\/+/g,"/");console.log("base url for fetch",t);var r=t+this.metaId,s=r+this.queryString.replace(/^\?*/,"?");"GET"===this.method&&(location.host+s).length>1e3&&(this.method="POST");var o=new Headers;o.append("Content-Type","application/json");var n={method:this.method,headers:o,credentials:"same-origin"};return"GET"!==this.method&&(n.body=JSON.stringify(this.data)),fetch("GET"===this.method?s:r,n).then(function(e){var t=e.json();return e.status>=200&&e.status<300?t:t.then(Promise.reject.bind(Promise))}).catch(function(t){throw console.groupCollapsed(e.method,t.statusCode,t.title),"message"in t&&console.error(t.message),console.groupEnd(),t.title})},Query.prototype.execute=function(e){var t=this;return e.then(function(e){return console.log("trying connection",t.config.version,t.method,t.metaId,JSON.stringify(t.args),JSON.stringify(t.data)),e.query("select status, message, response, mimetype from endpoint.request($1, $2, $3, $4::json, $5::json)",[t.config.version,t.method,t.metaId,JSON.stringify(t.args),JSON.stringify(t.data)]).then(function(e){if((e=e.rows[0]).status>=400)throw e;return e}).catch(function(t){e.release&&e.release(),console.log("error in endpoint.request query",t)})})},module.exports=Query;
