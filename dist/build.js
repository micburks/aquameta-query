"use strict";function Query(e){return this.config=e,this}module.exports=require("./").polyfill();var realFetch=require("node-fetch");module.exports=function(e,t){return/^\/\//.test(e)&&(e="https:"+e),realFetch.call(this,e,t)},global.fetch||(global.fetch=module.exports,global.Response=realFetch.Response,global.Headers=realFetch.Headers,global.Request=realFetch.Request);var asyncToGenerator=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function s(n,o){try{var a=t[n](o),i=a.value}catch(e){return void r(e)}if(!a.done)return Promise.resolve(i).then(function(e){s("next",e)},function(e){s("throw",e)});e(i)}return s("next")})}};Query.prototype.fromRequest=function(e){this.method=e.method,this.metaId=e.url.split("?")[0],this.args=e.query,this.data=e.body,this.args.metaData=!this.args.hasOwnProperty("metaData")||this.args.metaData,console.log("fromRequest args",this.args)},Query.prototype.fromDatum=function(e,t,r,s){var n=this;this.method=e,this.metaId=t.toUrl(),this.args=r||{},this.data=s||{},this.args.metaData=!this.args.hasOwnProperty("metaData")||this.args.metaData,this.queryString=Object.keys(this.args).sort().map(function(e){var t=n.args[e];switch(e){case"where":return(t=t.length?t:[t]).map(function(e){return"where="+encodeURIComponent(JSON.stringify(e))}).join("&");case"order_by":return t=t.length?t:[t],e+"="+encodeURIComponent(t.map(function(e,t){return("asc"!==e.direction?"-":"")+e.column}).join(","));case"limit":case"offset":var r=parseInt(t);if(!isNaN(r))return e+"="+r;return;case"evented":return"session_id="+encodeURIComponent(JSON.stringify(t));case"metaData":case"args":case"exclude":case"include":return e+"="+encodeURIComponent(JSON.stringify(t))}}).join("&").replace(/&&/g,"&"),console.log("fromDatum queryString",this.queryString)},Query.prototype.fetch=asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,s,n,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=("/"+this.config.url+"/"+this.config.version).replace(/\/+/g,"/"),console.log("base url for fetch",t),r=t+this.metaId,s=r+this.queryString.replace(/^\?*/,"?"),"GET"===this.method&&(location.host+s).length>1e3&&(this.method="POST"),(n=new Headers).append("Content-Type","application/json"),o={method:this.method,headers:n,credentials:"same-origin"},"GET"!==this.method&&(o.body=JSON.stringify(this.data)),a=void 0,e.prev=10,e.next=13,fetch("GET"===this.method?s:r,o);case 13:if(i=e.sent,a=i.json(),!(i.status<200||i.state>=300)){e.next=17;break}throw new Error(i);case 17:e.next=25;break;case 19:throw e.prev=19,e.t0=e.catch(10),console.groupCollapsed(this.method,e.t0.statusCode,e.t0.title),"message"in e.t0&&console.error(e.t0.message),console.groupEnd(),e.t0.title;case 25:return e.abrupt("return",a);case 26:case"end":return e.stop()}},e,this,[[10,19]])})),Query.prototype.execute=function(){var e=asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,s=void 0,e.prev=2,e.next=5,t;case 5:return s=e.sent,console.log("trying connection",this.config.version,this.method,this.metaId,JSON.stringify(this.args),JSON.stringify(this.data)),e.next=9,s.query("select status, message, response, mimetype from endpoint.request($1, $2, $3, $4::json, $5::json)",[this.config.version,this.method,this.metaId,JSON.stringify(this.args),JSON.stringify(this.data)]);case 9:if(r=e.sent,!((r=r.rows[0]).status>=400)){e.next=13;break}throw r;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),s.release&&s.release(),console.error("error in endpoint.request query",e.t0);case 19:return e.abrupt("return",r);case 20:case"end":return e.stop()}},e,this,[[2,15]])}));return function(t){return e.apply(this,arguments)}}(),module.exports=Query;
